services:
  rabbitmq:
    image: rabbitmq:4.2-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  # redis:
  #   image: redis:7
  #   ports:
  #     - "6379:6379"

 
  # content-service:
  #   build: ./services/content-service
  #   environment:
  #     RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
  #     DATABASE_URL: postgres://app:app@postgres:5432/content_db
  #     REDIS_URL: redis://redis:6379/0
  #     S3_ENDPOINT: http://seaweed-s3:8333
  #     S3_BUCKET: content
  #     S3_ACCESS_KEY: dev
  #     S3_SECRET_KEY: dev
  #   depends_on:
  #     - rabbitmq
  #     - postgres
  #     - redis
  #     - seaweed-master

  # user-service:
  #   build: ./services/user-service
  #   environment:
  #     RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
  #     DATABASE_URL: postgres://app:app@postgres:5432/users_db
  #   depends_on:
  #     - rabbitmq
  #     - postgres

  # SeaweedFS Deployment
  # --------------------------------------------------------------
  # Master node
  seaweed-master:
    image: chrislusf/seaweedfs:latest
    ports:
      - "9333:9333" # SeaweedFS master HTTP port
      - "19333:19333" # SeaweedFS master gRPC port
    command: "master -port=9333 -ip=seaweed-master" # Specify master's IP for internal communication
    volumes:
      - master_data:/data # Persistent storage for master data

  # Volume node
  seaweed-volume:
    image: chrislusf/seaweedfs:latest
    ports:
      - "8080:8080" # SeaweedFS volume HTTP port
    command: "volume -mserver=seaweed-master:9333 -port=8080 -ip=seaweed-volume" # Connects to master
    volumes:
      - volume_data:/data # Persistent storage for volume data
    depends_on:
      - seaweed-master # Ensures master starts before volume

  seaweed-filer:
    image: chrislusf/seaweedfs:latest
    command: ["filer", "-master=seaweed-master:9333", "-ip=seaweed-filer"]
    depends_on:
      - seaweed-master
      - seaweed-volume
    ports:
      - "8888:8888" # Filer UI and API port
      - "18888:18888" # Filer gRPC port
    
  seaweed-s3:
    image: chrislusf/seaweedfs:latest  # See Fix 2 below about this image
    container_name: seaweed-s3
    restart: on-failure
    # ADDED: -ip.bind=0.0.0.0
    command: "s3 -port=8333 -filer=seaweed-filer:8888 -ip.bind=0.0.0.0 -config=/config/s3_identity.json"
    ports:
      - "8333:8333"
    volumes:
      - ./s3_identity.json:/config/s3_identity.json:ro
    depends_on:
      - seaweed-filer

  # moderation-text:
  #   build: ./services/moderation-text
  #   environment:
  #     RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
  #     REDIS_URL: redis://redis:6379/1
  #     S3_ENDPOINT: http://seaweed-s3:8333
  #     S3_BUCKET: content
  #     S3_ACCESS_KEY: dev
  #     S3_SECRET_KEY: dev
  #     DETECTOR_MODE: in-process
  #     COMPOSITE_TIMEOUT_SECONDS: 2
  #   depends_on:
  #     - rabbitmq
  #     - redis
  #     - seaweed-master

  # moderation-image:
  #   build: ./services/moderation-image
  #   environment:
  #     RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
  #     REDIS_URL: redis://redis:6379/2
  #     S3_ENDPOINT: http://seaweed-s3:8333
  #     S3_BUCKET: content
  #     S3_ACCESS_KEY: dev
  #     S3_SECRET_KEY: dev
  #     DETECTOR_MODE: in-process
  #     COMPOSITE_TIMEOUT_SECONDS: 3
  #   depends_on:
  #     - rabbitmq
  #     - redis
  #     - seaweed-master

  # assignment-service:
  #   build: ./services/assignment-service
  #   environment:
  #     RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
  #     DATABASE_URL: postgres://app:app@postgres:5432/assignment_db
  #   depends_on:
  #     - rabbitmq
  #     - postgres

  # Moderation Deployment
  # --------------------------------------------------------------
  moderation-orchestrator:
    build:
      context: ./apps/moderation_orchestrator
      dockerfile: Dockerfile
    environment:
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/1
      S3_ENDPOINT: http://seaweed-s3:8333
      S3_BUCKET: content
      S3_ACCESS_KEY: dev
      S3_SECRET_KEY: dev
    depends_on:
      - rabbitmq
      # - redis
      # - seaweed-master
      - moderation-postgres

  moderation-postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: [ 'CMD-SHELL', 'pg_isready -U app -d postgres' ]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  pgdata:
  master_data:
  volume_data:

networks:
  default:
    name: safuforum-net
